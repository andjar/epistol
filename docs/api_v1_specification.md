# API v1 Specification

This document provides a specification for the API endpoints located under `/api/v1/`.

## Contents
- [/api/v1/add_member_to_group.php](#apiv1add_member_to_groupphp)
- [/api/v1/create_group.php](#apiv1create_groupphp)
- [/api/v1/delete_group.php](#apiv1delete_groupphp)
- [/api/v1/get_feed.php](#apiv1get_feedphp)
- [/api/v1/get_group_members.php](#apiv1get_group_membersphp)
- [/api/v1/get_groups.php](#apiv1get_groupsphp)
- [/api/v1/get_profile.php](#apiv1get_profilephp)
- [/api/v1/get_thread.php](#apiv1get_threadphp)
- [/api/v1/remove_member_from_group.php](#apiv1remove_member_from_groupphp)
- [/api/v1/send_email.php](#apiv1send_emailphp)
- [/api/v1/set_post_status.php](#apiv1set_post_statusphp)
- [/api/v1/download_attachment.php (Presumed)](#apiv1download_attachmentphp-presumed)

---

## /api/v1/add_member_to_group.php
- **Method**: `POST`
- **Description**: Adds a specified person (member) to a specified group.
- **Path**: `/api/v1/add_member_to_group.php`
- **Request Parameters (JSON Body)**:
    - `group_id` (string, required): The ID of the group to add the member to.
    - `person_id` (string, required): The ID of the person to add to the group.
    - **Example JSON Input**:
      ```json
      {
        "group_id": "grp_abc123",
        "person_id": "psn_xyz789"
      }
      ```
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Indicates the member was successfully added or was already a member.
      ```json
      {
        "status": "success",
        "data": {
          "message": "Member added to group successfully."
        }
      }
      ```
      or
      ```json
      {
        "status": "success",
        "data": {
          "message": "Member already in group or added successfully."
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON input, or missing/empty `group_id` or `person_id`.
        - Example: `{"status": "error", "message": "Group ID is required."}`
    - `404 Not Found`: If the specified `group_id` or `person_id` does not exist.
        - Example: `{"status": "error", "message": "Group not found."}`
    - `405 Method Not Allowed`: If the request method is not `POST`.
        - Example: `{"status": "error", "message": "Invalid request method. Only POST requests are allowed."}`
    - `500 Internal Server Error`: Database error or other unexpected server error.
        - Example: `{"status": "error", "message": "A database error occurred."}`
- **Database Interaction (Brief)**:
    - Validates existence of `group_id` in `groups` table and `person_id` in `persons` table.
    - Inserts a new record into `group_members` table (linking `person_id` and `group_id`) with a `joined_at` timestamp.
    - Handles unique constraint violations (member already exists) as a success.

---

## /api/v1/create_group.php
- **Method**: `POST`
- **Description**: Creates a new group with a specified name and optionally adds initial members. A unique `group_id` is generated by the server.
- **Path**: `/api/v1/create_group.php`
- **Request Parameters (JSON Body)**:
    - `group_name` (string, required): The name for the new group.
    - `member_person_ids` (array of strings, optional): An array of `person_id`s to initially add to the group.
    - **Example JSON Input**:
      ```json
      {
        "group_name": "Project Alpha Team",
        "member_person_ids": ["psn_xyz789", "psn_abc123"]
      }
      ```
- **Success Response**:
    - **Status Code**: `201 Created`
    - **Body**: Indicates the group was successfully created, returning the new `group_id` and `group_name`.
      ```json
      {
        "status": "success",
        "data": {
          "message": "Group created successfully.",
          "group_id": "grp_generated_uuid_string",
          "group_name": "Project Alpha Team"
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON, missing `group_name`, or invalid `member_person_ids`.
        - Example: `{"status": "error", "message": "Group name is required."}`
    - `405 Method Not Allowed`: If method is not `POST`.
    - `409 Conflict`: If a group with the same `group_name` already exists.
        - Example: `{"status": "error", "message": "A group with the name 'Project Alpha Team' already exists."}`
    - `500 Internal Server Error`: Database error.
- **Database Interaction (Brief)**:
    - Inserts a new record into `groups` table.
    - If `member_person_ids` provided, validates each `person_id` against `persons` table (skipping if not found) and inserts valid ones into `group_members`. Uses a transaction.

---

## /api/v1/delete_group.php
- **Method**: `POST` (uses POST for delete to allow JSON body)
- **Description**: Deletes a specified group and removes all its members from the `group_members` table.
- **Path**: `/api/v1/delete_group.php`
- **Request Parameters (JSON Body)**:
    - `group_id` (string, required): The ID of the group to delete.
    - **Example JSON Input**:
      ```json
      {
        "group_id": "grp_abc123"
      }
      ```
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Indicates successful deletion.
      ```json
      {
        "status": "success",
        "data": {
          "message": "Group deleted successfully."
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON or missing `group_id`.
    - `404 Not Found`: If the `group_id` does not exist.
    - `405 Method Not Allowed`: If method is not `POST`.
    - `500 Internal Server Error`: Database error.
- **Database Interaction (Brief)**:
    - Deletes from `group_members` for the `group_id`.
    - Deletes from `groups` for the `group_id`. Uses a transaction.

---

## /api/v1/get_feed.php
- **Method**: `GET`
- **Description**: Fetches a paginated feed of email threads for a given user. Allows filtering by group and email status. Emails within each thread are ordered by timestamp; threads are ordered by the timestamp of their most recent email. (Note: This documentation is based on the original comments in the file, as later attempts to update its specific comment block in previous subtasks were problematic.)
- **Path**: `/api/v1/get_feed.php`
- **Request Parameters ($\_GET)**:
    - `user_id` (integer, required): The ID of the user for whom to fetch the feed. Determines user-specific data like email read status.
    - `page` (integer, optional, default: 1): Page number for pagination.
    - `limit` (integer, optional, default: 20 from config, max: 100): Number of threads per page. (Original file logic has `filter_var` that might not include max_range for limit, but it's a good practice).
    - `group_id` (string, optional): Filters emails to those associated with this `group_id`. (Note: Affects emails within globally paginated threads).
    - `status` (string, optional): Filters emails by status for the `user_id` (e.g., 'read', 'unread', 'follow-up', 'important-info').
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Paginated list of threads, each containing emails.
      ```json
      {
        "status": "success",
        "data": {
          "threads": [
            {
              "thread_id": "thr_abc123",
              "subject": "Discussion about Project X",
              "participants": ["Sender Name A", "Sender Name B"],
              "last_reply_time": "YYYY-MM-DD HH:MM:SS",
              "emails": [
                {
                  "email_id": "eml_xyz789",
                  "sender_name": "Sender Name A",
                  "body_preview": "First email snippet...",
                  "timestamp": "YYYY-MM-DD HH:MM:SS",
                  "status": "read"
                }
              ]
            }
          ],
          "pagination": {
            "current_page": 1,
            "per_page": 20,
            "total_items": 50,
            "total_pages": 3
          }
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid or missing `user_id`, `page`, or `limit`.
    - `405 Method Not Allowed`: If method is not `GET`.
    - `500 Internal Server Error`: Database/server error.
- **Database Interaction (Brief)**:
    - Fetches threads, emails, persons, and post_statuses. Uses subqueries for pagination and complex joins. Applies filters. Groups emails into threads. (Based on original complex logic in the file).

---

## /api/v1/get_group_members.php
- **Method**: `GET`
- **Description**: Fetches a paginated list of members for a specified group. Member details are retrieved by joining with the `persons` table.
- **Path**: `/api/v1/get_group_members.php`
- **Request Parameters ($\_GET)**:
    - `group_id` (string, required): The ID of the group.
    - `page` (integer, optional, default: 1): Page number.
    - `limit` (integer, optional, default: 10, max: 100): Members per page.
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: List of members with pagination.
      ```json
      {
        "status": "success",
        "data": {
          "group_id": "grp_abc123",
          "members": [
            {
              "person_id": "psn_xyz789",
              "name": "John Doe",
              "email": "john.doe@example.com",
              "avatar_url": "/avatars/psn_xyz789.png",
              "joined_at": "YYYY-MM-DD HH:MM:SS"
            }
          ],
          "pagination": {
            "current_page": 1,
            "per_page": 10,
            "total_pages": 3,
            "total_members": 25
          }
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Missing `group_id`.
    - `404 Not Found`: If `group_id` does not exist.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Validates `group_id` in `groups`. Queries `group_members` joined with `persons`. Implements pagination.

---

## /api/v1/get_groups.php
- **Method**: `GET`
- **Description**: Fetches a paginated list of all groups, including ID, name, creation date, and member count. Groups are ordered by creation date descending.
- **Path**: `/api/v1/get_groups.php`
- **Request Parameters ($\_GET)**:
    - `page` (integer, optional, default: 1): Page number.
    - `limit` (integer, optional, default: 10, max: 100): Groups per page.
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: List of groups with pagination.
      ```json
      {
        "status": "success",
        "data": {
          "groups": [
            {
              "group_id": "grp_abc123",
              "group_name": "Administrators",
              "created_at": "YYYY-MM-DD HH:MM:SS",
              "member_count": 5
            }
          ],
          "pagination": {
            "current_page": 1,
            "per_page": 10,
            "total_pages": 7,
            "total_groups": 68
          }
        }
      }
      ```
- **Error Responses**:
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Queries `groups` table. Uses a subquery for `member_count` from `group_members`. Implements pagination.

---

## /api/v1/get_profile.php
- **Method**: `GET`
- **Description**: Fetches profile information for a specified person (basic details, email addresses, placeholder for threads).
- **Path**: `/api/v1/get_profile.php`
- **Request Parameters ($\_GET)**:
    - `person_id` (string, required): The ID of the person.
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Profile data.
      ```json
      {
        "status": "success",
        "data": {
          "id": "psn_xyz789",
          "name": "John Doe",
          "avatar_url": "/avatars/psn_xyz789.png",
          "bio": "Software developer...",
          "created_at": "YYYY-MM-DD HH:MM:SS",
          "email_addresses": [
            {"email": "john.doe@example.com", "is_primary": true}
          ],
          "threads": []
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Missing `person_id`.
    - `404 Not Found`: If `person_id` does not exist.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Fetches from `persons` table for core details.
    - Fetches from `email_addresses` table. `threads` is currently a placeholder.

---

## /api/v1/get_thread.php
- **Method**: `GET`
- **Description**: Fetches all emails within a specific thread, thread metadata (subject), and participants. Emails are ordered by timestamp. User-specific email status is included.
- **Path**: `/api/v1/get_thread.php`
- **Request Parameters ($\_GET)**:
    - `thread_id` (string, required): The ID of the thread.
    - `user_id` (string, required): The ID of the user requesting, for email status context.
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Thread details with emails.
      ```json
      {
        "status": "success",
        "data": {
          "id": "thr_abc123",
          "subject": "Important Discussion",
          "participants": [
            {"id": "psn_sender1", "name": "Sender One", "avatar_url": "/avatars/sender1.png"}
          ],
          "emails": [
            {
              "id": "eml_xyz789",
              "sender": {"id": "psn_sender1", "name": "Sender One", "avatar_url": "..."},
              "body_html": "<p>Hello!</p>",
              "body_text": "Hello!",
              "timestamp": "YYYY-MM-DD HH:MM:SS",
              "status": "read",
              "attachments": []
            }
          ]
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Missing `thread_id` or `user_id`.
    - `404 Not Found`: If `thread_id` does not exist.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Fetches subject from `threads`. Fetches emails from `emails`, joining `persons` for sender and `post_statuses` for email status. Derives participants.

---

## /api/v1/remove_member_from_group.php
- **Method**: `POST` (uses POST for operation to allow JSON body)
- **Description**: Removes a specified person from a specified group. Idempotent.
- **Path**: `/api/v1/remove_member_from_group.php`
- **Request Parameters (JSON Body)**:
    - `group_id` (string, required): The ID of the group.
    - `person_id` (string, required): The ID of the person to remove.
    - **Example JSON Input**:
      ```json
      {
        "group_id": "grp_abc123",
        "person_id": "psn_xyz789"
      }
      ```
- **Success Response**:
    - **Status Code**: `200 OK`
    - **Body**: Indicates member removed or was not in the group.
      ```json
      {
        "status": "success",
        "data": {
          "message": "Member removed or was not in group."
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON, or missing IDs.
    - `404 Not Found`: If `group_id` or `person_id` itself doesn't exist.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Validates `group_id` in `groups` and `person_id` in `persons`.
    - Deletes from `group_members` for the `group_id` and `person_id`.

---

## /api/v1/send_email.php
- **Method**: `POST`
- **Description**: Sends an email using an SMTP gateway and records the email, its recipients, attachments, and thread information in the database. If replying, it uses the existing thread; otherwise, a new thread is created. (Note: This documentation is based on the original comments in the file, as later attempts to update its specific comment block in previous subtasks were problematic.)
- **Path**: `/api/v1/send_email.php`
- **Request Parameters (JSON Body)**:
    - `recipients` (array of strings, required): Recipient email addresses.
    - `subject` (string, required): Email subject.
    - `body_html` (string, optional): HTML body.
    - `body_text` (string, optional): Plain text body. (At least one body type required).
    - `from_person_id` (string, using `DEFAULT_USER_PERSON_ID` in current code): ID of the sender person.
    - `in_reply_to_email_id` (string, optional): ID of email being replied to.
    - `attachments` (array of objects, optional): Each object: `filename` (string), `content_base64` (string), `mimetype` (string).
    - **Example JSON Input**:
      ```json
      {
        "recipients": ["recipient1@example.com"],
        "subject": "Project Update",
        "body_html": "<p>Update.</p>",
        "from_person_id": "psn_sender123",
        "attachments": [{"filename": "file.pdf", "content_base64": "...", "mimetype": "application/pdf"}]
      }
      ```
- **Success Response**:
    - **Status Code**: `200 OK` (The file uses `send_json_success` which defaults to 200 OK, though 201 might be more appropriate for resource creation).
    - **Body**: Confirmation with created email and thread IDs.
      ```json
      {
        "status": "success",
        "data": {
          "message": "Email sent and saved successfully.",
          "email_id": "eml_generated_id",
          "thread_id": "thr_generated_or_existing_id"
        }
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON, missing fields, invalid email/attachment format.
    - `404 Not Found`: If `in_reply_to_email_id` not found.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`: SMTP failure, DB error, file system error.
- **Database Interaction (Brief)**:
    - Uses SMTP to send. Then, in a transaction: finds/creates thread in `threads`; inserts into `emails`; finds/creates recipients in `persons` and `email_addresses`; adds to `email_recipients`; saves attachments to disk and `attachments` table; updates `threads.last_activity_at`. (Based on original complex logic in the file).

---

## /api/v1/set_post_status.php
- **Method**: `POST`
- **Description**: Sets or updates the status for a specific post (email) for a given user.
- **Path**: `/api/v1/set_post_status.php`
- **Request Parameters (JSON Body)**:
    - `post_id` (integer, required): ID of the post (email).
    - `user_id` (integer, required): ID of the user.
    - `status` (string, required): Status to set (e.g., 'read', 'follow-up', 'unread'). Allowed values: 'read', 'follow-up', 'important-info', 'unread'.
    - **Example JSON Input**:
      ```json
      {
        "post_id": 123,
        "user_id": 456,
        "status": "read"
      }
      ```
- **Success Response**:
    - **Status Code**: `200 OK` (if updated), `201 Created` (if created).
    - **Body**: Confirmation message.
      ```json
      {
        "status": "success",
        "data": {"message": "Post status updated successfully."}
      }
      ```
      or
      ```json
      {
        "status": "success",
        "data": {"message": "Post status created successfully.", "id": "generated_status_id"}
      }
      ```
- **Error Responses**:
    - `400 Bad Request`: Invalid JSON, missing fields, invalid status value.
    - `405 Method Not Allowed`.
    - `500 Internal Server Error`.
- **Database Interaction (Brief)**:
    - Checks `post_statuses` for existing record (`post_id`, `user_id`). Updates if found, otherwise inserts. Manages `created_at` and `updated_at` timestamps.

---

## /api/v1/download_attachment.php (Presumed)
- **Method**: `GET` (Presumed)
- **Description**: Downloads an email attachment. The actual backend script `api/v1/download_attachment.php` was not found or created during the refactoring of other `api/v1/` endpoints, but is referenced in frontend JavaScript (`public/js/api.js`).
- **Path**: `/api/v1/download_attachment.php`
- **Request Parameters ($\_GET)**:
    - `file_id` (string, required): The ID of the attachment file to download (likely corresponds to `attachments.id` or `attachments.attachment_id` in the database).
- **Success Response**:
    - **Status Code**: `200 OK` (Presumed)
    - **Body**: The raw file content with appropriate `Content-Type` and `Content-Disposition` headers for download.
- **Error Responses**:
    - `400 Bad Request`: Missing `file_id`.
    - `404 Not Found`: If `file_id` does not correspond to an existing attachment.
    - `500 Internal Server Error`: Error accessing file or database.
- **Database Interaction (Brief)** (Presumed):
    - Queries the `attachments` table to find the attachment record by `file_id`.
    - Retrieves `filepath_on_disk`, original `filename`, and `mimetype` to serve the file.

---
Markdown content generated.
